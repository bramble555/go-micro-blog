{{ define "content" }}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb;
    }

    .article-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .article-card:hover {
        transform: translateY(-4px);
        border-color: #3b82f6;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .detail-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 24px;
        border: 1px solid #f3f4f6;
    }

    .detail-body {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #374151;
        white-space: pre-wrap;
        margin-bottom: 40px;
    }

    .comment-box {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #f3f4f6;
    }

    .comment-item {
        padding: 15px 0;
        border-bottom: 1px solid #f9fafb;
    }

    .comment-user {
        font-weight: 700;
        color: #111827;
        font-size: 14px;
    }

    .comment-text {
        color: #4b5563;
        margin-top: 5px;
        font-size: 15px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        color: #3b82f6;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 20px;
    }
</style>

<div class="container mx-auto py-12" style="max-width: 900px; margin: 0 auto; padding: 0 20px;">
    <div id="list-view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <h1 style="font-size: 32px; font-weight: 800;">æœ€æ–°æ–‡ç« </h1>
            <div id="auth-zone">
                <a href="/admin/login"
                    style="background: #1f2937; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none;">ç®¡ç†å‘˜ç™»å½•</a>
            </div>
        </div>
        <div id="article-list">åŠ è½½ä¸­...</div>
    </div>

    <div id="detail-view" style="display: none;">
        <div class="back-link" onclick="handleBackToList()">
            <svg style="width:20px; height:20px; margin-right:8px" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path d="M10 19l-7-7m0 0l7-7m-7 7h18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            è¿”å›åˆ—è¡¨
        </div>
        <article class="detail-container">
            <h1 id="detail-title" style="font-size: 36px; font-weight: 800; margin-bottom: 15px;"></h1>
            <div id="detail-date" style="color: #9ca3af; margin-bottom: 30px;"></div>
            <div id="detail-content" class="detail-body"></div>
            <section class="comment-box">
                <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 20px;">è¯„è®ºå›å¤</h3>
                <textarea id="comment-input" placeholder="æ’°å†™ä½ çš„è¯„è®º..."
                    style="width: 100%; height: 100px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 12px; resize: none; margin-bottom: 15px;"></textarea>
                <div style="text-align: right;">
                    <button onclick="submitComment()"
                        style="background: #3b82f6; color: white; padding: 10px 25px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;">å‘å¸ƒè¯„è®º</button>
                </div>
                <div id="comment-list" style="margin-top: 30px;"></div>
            </section>
        </article>
    </div>
</div>

<script>
    let currentArticleId = null;

    document.addEventListener('DOMContentLoaded', () => {
        // 1. ç™»å½•çŠ¶æ€
        const token = localStorage.getItem('token');
        if (token) {
            document.getElementById('auth-zone').innerHTML = `
                <a href="/admin/create" style="background:#10b981; color:white; padding:10px 20px; border-radius:10px; text-decoration:none; margin-right:10px;">+ æ–°æ–‡ç« </a>
                <button onclick="logout()" style="background:#ef4444; color:white; padding:10px 20px; border-radius:10px; border:none; cursor:pointer;">é€€å‡º</button>
            `;
        }

        // 2. ğŸš€ å…³é”®é€»è¾‘ï¼šä» URL å‚æ•°è§£æ ID (?id=xxx)
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        if (id) {
            console.log("æ£€æµ‹åˆ°è¯¦æƒ…é¡µå‚æ•° ID:", id);
            renderDetail(id, false);
        } else {
            loadArticles();
        }

        window.onpopstate = (e) => {
            const params = new URLSearchParams(window.location.search);
            const pid = params.get('id');
            if (pid) renderDetail(pid, false);
            else renderList(false);
        };
    });

    async function loadArticles() {
        try {
            const res = await fetch('/api/articles');
            const result = await res.json();
            const list = document.getElementById('article-list');
            list.innerHTML = '';
            result.data.forEach(post => {
                list.innerHTML += `
                    <div class="article-card" onclick="showDetail('${post.id}')">
                        <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 8px;">${post.title}</h2>
                        <p style="color: #6b7280; margin-bottom: 12px;">${post.summary}</p>
                        <span style="font-size: 13px; color: #9ca3af;">ğŸ“… ${post.created_at.substring(0, 10)}</span>
                    </div>
                `;
            });
        } catch (err) { console.error(err); }
    }

    function showDetail(id) { renderDetail(id, true); }

    async function renderDetail(id, push) {
        currentArticleId = id;
        try {
            const res = await fetch(`/api/articles/${id}`);
            const result = await res.json();
            if (result.code === 200) {
                document.getElementById('list-view').style.display = 'none';
                document.getElementById('detail-view').style.display = 'block';
                document.getElementById('detail-title').innerText = result.data.title;
                document.getElementById('detail-content').innerText = result.data.content;
                document.getElementById('detail-date').innerText = "å‘å¸ƒäº " + result.data.created_at.substring(0, 10);

                // ğŸš€ è¿™é‡Œä¿®æ”¹ URL ä¸º ?id=xxx
                if (push) window.history.pushState({ articleId: id }, "", `/?id=${id}`);
                window.scrollTo({ top: 0, behavior: 'smooth' });

                loadComments(id);
            }
        } catch (err) { alert("åŠ è½½æ–‡ç« å¤±è´¥"); }
    }

    async function loadComments(id) {
        const cList = document.getElementById('comment-list');
        cList.innerHTML = '<p style="color: #9ca3af;">æ­£åœ¨åŠ è½½è¯„è®º...</p>';
        try {
            const res = await fetch(`/api/comments?article_id=${id}`);
            const result = await res.json();
            if (result.data && result.data.length > 0) {
                cList.innerHTML = result.data.map(c => `
                    <div class="comment-item">
                        <div class="comment-user">æ¸¸å®¢</div>
                        <div class="comment-text">${c.content}</div>
<div style="font-size:12px; color:#d1d5db; margin-top:5px;">
    ${c.created_at.replace('T', ' ').substring(0, 16)}
</div>
                    </div>
                `).join('');
            } else {
                cList.innerHTML = '<p style="color: #9ca3af;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</p>';
            }
        } catch (err) { cList.innerHTML = ''; }
    }

    async function submitComment() {
        const content = document.getElementById('comment-input').value;
        if (!content) return alert("è¯·è¾“å…¥å†…å®¹");
        try {
            const res = await fetch('/api/comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ article_id: currentArticleId, content: content, nickname: "åŒ¿åç”¨æˆ·" })
            });
            const result = await res.json();
            if (result.code === 200) {
                document.getElementById('comment-input').value = '';
                loadComments(currentArticleId);
            }
        } catch (err) { alert("ç½‘ç»œé”™è¯¯"); }
    }

    function handleBackToList() { renderList(true); }

    function renderList(push) {
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('detail-view').style.display = 'none';
        if (push) window.history.pushState({}, "", "/");
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function logout() { localStorage.removeItem('token'); window.location.href = '/'; }
</script>
{{ end }}