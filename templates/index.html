{{ define "content" }}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb;
    }

    .article-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s;
        cursor: pointer;
        margin-bottom: 20px;
    }

    .article-card:hover {
        transform: translateY(-4px);
        border-color: #3b82f6;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .detail-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 24px;
        border: 1px solid #f3f4f6;
    }

    .detail-body {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #374151;
        white-space: normal;
        /* Markdown content should wrap normally */
        margin-bottom: 40px;
    }

    .article-content h1,
    .article-content h2,
    .article-content h3 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 700;
        color: #111827;
    }

    .article-content p {
        margin-bottom: 16px;
    }

    .article-content ul,
    .article-content ol {
        margin-bottom: 16px;
        padding-left: 24px;
    }

    .article-content li {
        margin-bottom: 8px;
    }

    .article-content code {
        background-color: #f3f4f6;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
    }

    .article-content pre {
        background-color: #1f2937;
        color: #f9fafb;
        padding: 16px;
        border-radius: 8px;
        overflow-x: auto;
        margin-bottom: 16px;
    }

    .article-content pre code {
        background-color: transparent;
        padding: 0;
        color: inherit;
    }

    .article-content blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 16px;
        color: #6b7280;
        font-style: italic;
        margin-bottom: 16px;
    }

    .article-content img {
        max-width: 100%;
        border-radius: 8px;
        margin: 20px 0;
    }

    .comment-box {
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #f3f4f6;
    }

    .comment-item {
        padding: 15px 0;
        border-bottom: 1px solid #f9fafb;
    }

    .comment-user {
        font-weight: 700;
        color: #111827;
        font-size: 14px;
    }

    .comment-text {
        color: #4b5563;
        margin-top: 5px;
        font-size: 15px;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        color: #3b82f6;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 20px;
    }

    /* é˜…è¯»è¿›åº¦æ¡æ ·å¼ */
    #reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 4px;
        background: linear-gradient(to right, #3b82f6, #10b981);
        z-index: 9999;
        transition: width 0.1s ease-out;
    }

    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        background: #10b981;
        color: white;
    }

    .toast.error {
        background: #ef4444;
        color: white;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

<div class="container mx-auto py-12" style="max-width: 900px; margin: 0 auto; padding: 0 20px;">
    <div id="list-view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <h1 style="font-size: 32px; font-weight: 800;">æœ€æ–°æ–‡ç« </h1>
            <div id="auth-zone">
                <a href="/admin/login"
                    style="background: #1f2937; color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none;">ç®¡ç†å‘˜ç™»å½•</a>
            </div>
        </div>
        <div id="article-list">åŠ è½½ä¸­...</div>
    </div>

    <div id="detail-view" style="display: none;">
        <div id="reading-progress"></div>
        <div class="back-link" onclick="backToList()">â† è¿”å›åˆ—è¡¨</div>
        <div id="article-detail" class="detail-container">
            <!-- åŠ¨æ€æ¸²æŸ“å†…å®¹ -->
        </div>
    </div>
</div>
<script src="/assets/js/article.js"></script>
<script>
    let isAdmin = false;

    document.addEventListener('DOMContentLoaded', async () => {
        // 1. å°è¯•ä½¿ç”¨æœåŠ¡ç«¯éªŒè¯çš„ /api/me æ¥åˆ¤æ–­æ˜¯å¦ç®¡ç†å‘˜
        const token = localStorage.getItem('token');
        if (token) {
            try {
                const res = await fetch('/api/me', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.ok) {
                    const data = await res.json();
                    if (data.code === 200 && data.data && data.data.roles && data.data.roles.indexOf('admin') !== -1) {
                        isAdmin = true;
                    }
                }
            } catch (e) { /* ignore */ }
        }

        if (isAdmin) {
            document.getElementById('auth-zone').innerHTML = `
                <a href="/admin/create" style="background:#10b981; color:white; padding:10px 20px; border-radius:10px; text-decoration:none; margin-right:10px;">+ æ–°æ–‡ç« </a>
                <button onclick="logout()" style="background:#ef4444; color:white; padding:10px 20px; border-radius:10px; border:none; cursor:pointer;">é€€å‡º</button>
            `;
        }

        // 2. åŠ è½½æ–‡ç« åˆ—è¡¨æˆ–è¯¦æƒ…
        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');
        if (articleId) {
            showDetail(articleId);
        } else {
            loadArticles();
        }
    });

    async function loadArticles() {
        try {
            const res = await fetch('/api/articles');
            const result = await res.json();
            const list = document.getElementById('article-list');
            list.innerHTML = '';
            result.data.forEach(post => {
                list.innerHTML += `
                    <div class="article-card" style="position: relative;">
                        <div onclick="showDetail('${post.id}')">
                            <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 8px;">${post.title}</h2>
                            <p style="color: #6b7280; margin-bottom: 12px;">${(post.content || '').substring(0, 100)}...</p>
                            <span style="font-size: 13px; color: #9ca3af;">ğŸ“… ${post.created_at.substring(0, 10)}</span>
                        </div>
                        ${isAdmin ? `
                            <button onclick="confirmDelete('${post.id}', event)" 
                                style="position: absolute; right: 24px; top: 24px; background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; z-index: 10;">
                                åˆ é™¤
                            </button>
                        ` : ''}
                    </div>
                `;
            });
        } catch (err) { console.error(err); }
    }

    async function confirmDelete(id, event) {
        if (event) event.stopPropagation();
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

        try {
            const result = await deleteArticle(id);
            if (result.code === 10000 || result.code === 200) {
                showToast('æ–‡ç« åˆ é™¤æˆåŠŸ', 'success');
                loadArticles();
            } else {
                showToast(result.msg || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (err) {
            showToast('åˆ é™¤è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // è®¡ç®—é˜…è¯»æ—¶é—´å‡½æ•°
    function estimateReadingTime(text) {
        const wordsPerMinute = 250; // å¹³å‡é˜…è¯»é€Ÿåº¦
        // åŒ¹é…ä¸­æ–‡å­—ç¬¦æˆ–è‹±æ–‡å•è¯
        const wordCount = (text.match(/[\u4e00-\u9fa5]|[\w-]+/g) || []).length;
        const minutes = wordCount / wordsPerMinute;

        if (minutes < 1) return 'å°‘äº 1 åˆ†é’Ÿ';
        // ç²¾ç¡®åˆ° 0.5 åˆ†é’Ÿ
        return (Math.round(minutes * 2) / 2).toFixed(1) + ' åˆ†é’Ÿ';
    }

    // æ»šåŠ¨è¿›åº¦ç›‘å¬
    function updateProgress() {
        const detailView = document.getElementById('detail-view');
        if (detailView.style.display === 'none') return;

        const winScroll = document.documentElement.scrollTop || document.body.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        const progressBar = document.getElementById('reading-progress');
        if (progressBar) progressBar.style.width = scrolled + "%";
    }

    window.onscroll = updateProgress;

    async function showDetail(id) {
        try {
            const res = await fetch(`/api/articles/${id}`);
            const result = await res.json();
            if (result.code !== 10000) {
                showToast(result.msg || 'è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥', 'error');
                return;
            }

            const { article, html_content, comments } = result.data;
            const detail = document.getElementById('article-detail');

            // è®¡ç®—é˜…è¯»æ—¶é—´ï¼ˆåŸºäºåŸå§‹ contentï¼‰
            const readingTime = estimateReadingTime(article.content || '');

            detail.innerHTML = `
                <h1 style="font-size: 36px; font-weight: 800; margin-bottom: 16px; color: #111827;">${article.title}</h1>
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #f3f4f6; display: flex; gap: 20px;">
                    <span>ğŸ“… ${article.created_at.substring(0, 10)}</span>
                    <span>â±ï¸ é¢„è®¡é˜…è¯»æ—¶é—´ï¼š${readingTime}</span>
                </div>
                <div class="detail-body article-content">${html_content}</div>
                
                <div class="comment-box">
                    <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">è¯„è®ºåŒº</h3>
                    
                    <!-- å‘è¡¨è¯„è®ºè¡¨å• -->
                    <div class="comment-form" style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                        <textarea id="commentInput" class="form-input" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; font-family: inherit;" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•... (æ”¯æŒMarkdown)"></textarea>
                        <button id="submitBtn" class="submit-btn" onclick="submitComment('${article.id}')" style="width: 100%; background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;">å‘å¸ƒè¯„è®º</button>
                    </div>

                    <div id="detail-comments">
                        <!-- åŠ¨æ€æ¸²æŸ“è¯„è®ºåˆ—è¡¨ -->
                    </div>
                </div>
            `;

            document.getElementById('list-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';
            window.scrollTo(0, 0);

            // åŠ è½½è¯„è®º
            loadComments(article.id);

            // å¯é€‰ï¼šæ›´æ–° URL ä½†ä¸åˆ·æ–°é¡µé¢
            history.pushState({ articleId: id }, '', `/?id=${id}`);
        } catch (err) {
            console.error(err);
            showToast('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
        }
    }

    async function submitComment(articleId) {
        const content = document.getElementById('commentInput').value.trim();
        if (!content) {
            showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'å‘å¸ƒä¸­...';

        try {
            const token = localStorage.getItem('token');
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = 'Bearer ' + token;

            const res = await fetch('/api/comments', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    article_id: articleId.toString(),
                    content: content
                })
            });

            const result = await res.json();
            if (result.code === 10000) {
                showToast('è¯„è®ºå‘å¸ƒæˆåŠŸï¼', 'success');
                document.getElementById('commentInput').value = '';
                loadComments(articleId);
            } else {
                showToast(result.msg || 'å‘å¸ƒå¤±è´¥', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'å‘å¸ƒè¯„è®º';
        }
    }

    async function loadComments(articleId) {
        try {
            const res = await fetch(`/api/comments?article_id=${articleId}`);
            const result = await res.json();

            if (result.code === 10000 && result.data) {
                const list = document.getElementById('detail-comments');
                if (result.data.length === 0) {
                    list.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</p>';
                    return;
                }

                list.innerHTML = result.data.map(c => `
                    <div class="comment-item">
                        <div class="comment-user">
                            ${c.nickname || 'æ¸¸å®¢'} 
                            <span style="font-weight: 400; color: #9ca3af; font-size: 12px; margin-left: 8px;">${c.created_at.substring(0, 16).replace('T', ' ')}</span>
                            ${isAdmin ? `<button onclick="deleteComment('${c.id}', '${articleId}')" style="background:transparent; border:none; color:#ef4444; cursor:pointer; font-size:12px; margin-left:8px">åˆ é™¤</button>` : ''}
                        </div>
                        <div class="comment-text">${c.content}</div>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error('åŠ è½½è¯„è®ºå¤±è´¥:', err);
        }
    }

    async function deleteComment(id, articleId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;

        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/admin/comments/${id}/delete`, {
                method: 'POST',
                headers: token ? { 'Authorization': 'Bearer ' + token } : {}
            });
            const result = await res.json();
            if (result.code === 10000) {
                showToast('åˆ é™¤æˆåŠŸ', 'success');
                loadComments(articleId);
            } else {
                showToast(result.msg || 'åˆ é™¤å¤±è´¥', 'error');
            }
        } catch (e) { showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error'); }
    }

    function backToList() {
        document.getElementById('detail-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'block';
        history.pushState({}, '', '/');
    }

    // å¤„ç†æµè§ˆå™¨å‰è¿›åé€€
    window.onpopstate = function (event) {
        if (event.state && event.state.articleId) {
            showDetail(event.state.articleId);
        } else {
            backToList();
        }
    };

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/';
    }
</script>
{{ end }}